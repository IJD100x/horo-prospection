<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horo AI ‚Äî Prospection</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #08080f;
    --surface: #10101c;
    --card: #15152a;
    --border: #1e1e38;
    --accent: #6c63ff;
    --accent2: #a78bfa;
    --accent-glow: rgba(108,99,255,0.15);
    --text: #e8e6f0;
    --muted: #6b6890;
    --red: #ff4d6d;
    --orange: #ff9f43;
    --green: #0be881;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* NOISE OVERLAY */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(8,8,15,0.92);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .logo {
    font-family: var(--font-head);
    font-size: 1.1rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo span {
    color: var(--accent2);
  }

  .logo-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 10px var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #urgency-badge {
    display: none;
    background: var(--red);
    color: white;
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 0.75rem;
    padding: 4px 12px;
    border-radius: 20px;
    animation: flash 1.5s infinite;
  }

  @keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* MAIN */
  main {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* UPLOAD SCREEN */
  #upload-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    gap: 2rem;
    text-align: center;
  }

  .upload-title {
    font-family: var(--font-head);
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    line-height: 1.1;
  }

  .upload-title em {
    color: var(--accent2);
    font-style: normal;
  }

  .upload-sub {
    color: var(--muted);
    font-size: 0.85rem;
    max-width: 400px;
    line-height: 1.8;
  }

  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 3rem 4rem;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--card);
    position: relative;
    overflow: hidden;
  }

  .upload-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, var(--accent-glow) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .upload-zone:hover::before { opacity: 1; }
  .upload-zone:hover { border-color: var(--accent); }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
  }

  .upload-label {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 1rem;
    color: var(--text);
  }

  .upload-hint {
    color: var(--muted);
    font-size: 0.75rem;
    margin-top: 0.5rem;
  }

  #file-input { display: none; }

  .btn-primary {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.02em;
  }

  .btn-primary:hover {
    background: var(--accent2);
    transform: translateY(-1px);
    box-shadow: 0 4px 20px rgba(108,99,255,0.4);
  }

  .btn-ghost {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: var(--font-mono);
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-ghost:hover {
    border-color: var(--accent);
    color: var(--accent2);
  }

  .btn-email {
    background: rgba(108,99,255,0.12);
    color: var(--accent2);
    border: 1px solid rgba(108,99,255,0.3);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.72rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    font-family: var(--font-mono);
  }

  .btn-email:hover {
    background: rgba(108,99,255,0.25);
    border-color: var(--accent);
  }

  /* DASHBOARD */
  #dashboard { display: none; }

  /* TOP BAR */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .page-title {
    font-family: var(--font-head);
    font-size: 1.4rem;
    font-weight: 800;
    letter-spacing: -0.03em;
  }

  .page-title span { color: var(--accent2); }

  .top-actions { display: flex; gap: 0.75rem; align-items: center; }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .kpi-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .kpi-card:hover { border-color: var(--accent); }

  .kpi-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    opacity: 0;
    transition: opacity 0.2s;
  }

  .kpi-card:hover::after { opacity: 1; }

  .kpi-label {
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }

  .kpi-value {
    font-family: var(--font-head);
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    line-height: 1;
  }

  .kpi-value.accent { color: var(--accent2); }
  .kpi-value.red { color: var(--red); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.orange { color: var(--orange); }

  /* CHART + FILTERS */
  .mid-section {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .card-title {
    font-family: var(--font-head);
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 1rem;
  }

  .filters-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .filters-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    padding: 8px 14px;
    flex: 1;
    min-width: 200px;
    transition: border-color 0.2s;
    outline: none;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  select.filter-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.78rem;
    padding: 8px 12px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    padding-right: 28px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b6890' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
  }

  select.filter-select:focus { border-color: var(--accent); }

  .filter-btn {
    background: rgba(255,77,109,0.1);
    color: var(--red);
    border: 1px solid rgba(255,77,109,0.3);
    padding: 8px 14px;
    border-radius: 8px;
    font-family: var(--font-mono);
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .filter-btn:hover, .filter-btn.active {
    background: rgba(255,77,109,0.2);
    border-color: var(--red);
  }

  /* TABLE */
  .table-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .table-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .table-count {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .table-wrapper { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.78rem;
  }

  thead th {
    background: var(--surface);
    padding: 10px 12px;
    text-align: left;
    font-family: var(--font-head);
    font-size: 0.68rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
  }

  tbody tr {
    border-bottom: 1px solid rgba(30,30,56,0.6);
    transition: background 0.15s;
    cursor: pointer;
  }

  tbody tr:hover { background: rgba(108,99,255,0.05); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 10px 12px;
    vertical-align: middle;
    white-space: nowrap;
  }

  .td-wrap { white-space: normal; max-width: 180px; }

  .td-name {
    font-family: var(--font-head);
    font-weight: 600;
    font-size: 0.82rem;
    color: var(--text);
  }

  .td-sub {
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 2px;
  }

  /* STATUS SELECT */
  .status-select {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    padding: 4px 8px;
    cursor: pointer;
    outline: none;
    transition: all 0.2s;
    max-width: 170px;
    appearance: none;
    padding-right: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' fill='none'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%236b6890' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }

  .status-select:focus { border-color: var(--accent); }

  /* RELANCE BADGE */
  .relance-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.68rem;
    font-weight: 500;
    white-space: nowrap;
  }

  .relance-badge.late {
    background: rgba(255,77,109,0.15);
    color: var(--red);
    border: 1px solid rgba(255,77,109,0.3);
  }

  .relance-badge.today {
    background: rgba(255,159,67,0.15);
    color: var(--orange);
    border: 1px solid rgba(255,159,67,0.3);
  }

  .relance-badge.ok {
    background: rgba(11,232,129,0.1);
    color: var(--green);
    border: 1px solid rgba(11,232,129,0.2);
  }

  .relance-badge.none {
    color: var(--muted);
    font-size: 0.65rem;
  }

  /* DATE INPUT */
  .date-input {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    padding: 4px 8px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
    width: 120px;
  }

  .date-input:focus { border-color: var(--accent); }
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0.5);
    cursor: pointer;
  }

  /* NOTES INPUT */
  .notes-input {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    padding: 4px 8px;
    outline: none;
    transition: border-color 0.2s;
    width: 150px;
    resize: none;
  }

  .notes-input:focus { border-color: var(--accent); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-title {
    font-family: var(--font-head);
    font-size: 1.1rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .modal-sub {
    color: var(--muted);
    font-size: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .modal-close {
    position: absolute;
    top: 1.25rem;
    right: 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .modal-close:hover { color: var(--text); border-color: var(--accent); }

  .history-list { display: flex; flex-direction: column; gap: 0.75rem; }

  .history-item {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    font-size: 0.78rem;
  }

  .history-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
    box-shadow: 0 0 6px var(--accent);
  }

  .history-time {
    color: var(--muted);
    font-size: 0.68rem;
    white-space: nowrap;
  }

  .history-text { color: var(--text); line-height: 1.5; }

  .empty-history {
    color: var(--muted);
    font-size: 0.78rem;
    text-align: center;
    padding: 2rem 0;
  }

  /* TOASTS */
  #toast-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.78rem;
    max-width: 280px;
    animation: slideIn 0.3s ease;
    border-left: 3px solid var(--accent);
  }

  .toast.success { border-left-color: var(--green); }
  .toast.warning { border-left-color: var(--orange); }

  @keyframes slideIn {
    from { transform: translateX(100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
    font-size: 0.82rem;
  }

  .no-email { color: var(--muted); font-size: 0.7rem; font-style: italic; }

  @media (max-width: 900px) {
    .mid-section { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 600px) {
    main { padding: 1rem; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    Horo<span>AI</span> ‚Äî Prospection
  </div>
  <div class="header-right">
    <span id="urgency-badge">üî• <span id="urgency-count">0</span> relances urgentes</span>
    <button class="btn-ghost" id="btn-export" style="display:none" onclick="exportExcel()">‚Üì Export Excel</button>
    <button class="btn-ghost" id="btn-reset" style="display:none" onclick="resetApp()">‚Ü∫ Reset</button>
  </div>
</header>

<main>
  <!-- UPLOAD SCREEN -->
  <div id="upload-screen">
    <div>
      <div class="upload-title">Suivi de<br><em>prospection</em></div>
      <p class="upload-sub" style="margin-top:0.75rem">Importe ton fichier Excel pour d√©marrer. Toutes les modifications sont sauvegard√©es automatiquement.</p>
    </div>
    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
      <span class="upload-icon">üìä</span>
      <div class="upload-label">Glisse ou clique pour importer</div>
      <div class="upload-hint">Prospection_Cabinets_Dentaires_HoroAI.xlsx</div>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFile(event)">
    <button class="btn-primary" onclick="loadDemo()">Charger les donn√©es de d√©mo</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="top-bar">
      <div class="page-title">Cabinets <span>Dentaires</span></div>
      <div class="top-actions">
        <button class="btn-ghost" onclick="document.getElementById('file-input').click()">‚Üë Importer</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Total prospects</div>
        <div class="kpi-value accent" id="kpi-total">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Contact√©s</div>
        <div class="kpi-value" id="kpi-contacted">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Relances urgentes</div>
        <div class="kpi-value red" id="kpi-urgent">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">En discussion</div>
        <div class="kpi-value orange" id="kpi-discussion">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">RDV pris</div>
        <div class="kpi-value green" id="kpi-rdv">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Taux de r√©ponse</div>
        <div class="kpi-value accent" id="kpi-rate">0%</div>
      </div>
    </div>

    <!-- CHART + FILTERS -->
    <div class="mid-section">
      <div class="chart-card">
        <div class="card-title">R√©partition</div>
        <canvas id="statusChart" height="220"></canvas>
      </div>
      <div class="filters-card">
        <div class="card-title">Filtres & Recherche</div>
        <div class="filters-row">
          <input type="text" class="search-input" id="search-input" placeholder="üîç Nom, ville, email..." oninput="applyFilters()">
          <select class="filter-select" id="filter-status" onchange="applyFilters()">
            <option value="">Tous les statuts</option>
            <option value="√Ä contacter">üîµ √Ä contacter</option>
            <option value="Email J0 envoy√©">üì§ Email J0 envoy√©</option>
            <option value="Relance J3 √† faire">üîÑ Relance J3</option>
            <option value="Relance J7 √† faire">üîÑ Relance J7</option>
            <option value="En discussion">üí¨ En discussion</option>
            <option value="Rendez-vous pris">‚úÖ RDV pris</option>
            <option value="Pas int√©ress√©">‚ùå Pas int√©ress√©</option>
            <option value="Sans r√©ponse">üö´ Sans r√©ponse</option>
          </select>
          <select class="filter-select" id="filter-city" onchange="applyFilters()">
            <option value="">Toutes les villes</option>
          </select>
          <button class="filter-btn" id="btn-urgent-filter" onclick="toggleUrgentFilter()">üî• Relances du jour</button>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-card">
      <div class="table-header">
        <div class="card-title" style="margin:0">Prospects</div>
        <div class="table-count" id="table-count">0 prospects</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Cabinet / Praticien</th>
              <th>Ville</th>
              <th>Contact</th>
              <th>Google</th>
              <th>Statut</th>
              <th>Date contact</th>
              <th>Prochaine action</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="prospects-tbody"></tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display:none">Aucun prospect trouv√©.</div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL HISTORIQUE -->
<div class="modal-overlay" id="history-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modal-prospect-name">Prospect</div>
    <div class="modal-sub" id="modal-prospect-sub"></div>
    <div class="history-list" id="history-list"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<script>
// ============================================================
// DATA
// ============================================================
let prospects = [];
let history = {}; // { prospectId: [{time, text}] }
let chart = null;
let urgentFilterActive = false;

const STATUSES = [
  'üîµ √Ä contacter',
  'üì§ Email J0 envoy√©',
  'üîÑ Relance J3 √† faire',
  'üîÑ Relance J7 √† faire',
  'üí¨ En discussion',
  '‚úÖ Rendez-vous pris',
  '‚ùå Pas int√©ress√©',
  'üö´ Sans r√©ponse'
];

const STATUS_VALUES = {
  'üîµ √Ä contacter': '√Ä contacter',
  'üì§ Email J0 envoy√©': 'Email J0 envoy√©',
  'üîÑ Relance J3 √† faire': 'Relance J3 √† faire',
  'üîÑ Relance J7 √† faire': 'Relance J7 √† faire',
  'üí¨ En discussion': 'En discussion',
  '‚úÖ Rendez-vous pris': 'Rendez-vous pris',
  '‚ùå Pas int√©ress√©': 'Pas int√©ress√©',
  'üö´ Sans r√©ponse': 'Sans r√©ponse'
};

// Reverse map
const VALUE_TO_EMOJI = {};
Object.entries(STATUS_VALUES).forEach(([k,v]) => VALUE_TO_EMOJI[v] = k);

// ============================================================
// INIT
// ============================================================
window.onload = () => {
  requestNotificationPermission();
  const saved = localStorage.getItem('horo_prospects');
  const savedHistory = localStorage.getItem('horo_history');
  if (saved) {
    prospects = JSON.parse(saved);
    history = savedHistory ? JSON.parse(savedHistory) : {};
    showDashboard();
  }
};

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

function sendNotification(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body, icon: '' });
  }
}

// ============================================================
// FILE HANDLING
// ============================================================
function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    parseExcelData(data);
  };
  reader.readAsBinaryString(file);
}

function parseExcelData(data) {
  // Find header row (row with "Nom du Cabinet")
  let headerIdx = data.findIndex(row => row.some(c => String(c).includes('Nom du Cabinet') || String(c).includes('Nom du Praticien')));
  if (headerIdx === -1) headerIdx = 2;

  const rows = data.slice(headerIdx + 1).filter(row => row.some(c => c !== ''));

  prospects = rows.map((row, i) => ({
    id: i,
    cabinet: row[0] || '',
    praticien: row[1] || '',
    ville: row[2] || '',
    email: row[3] || '',
    telephone: row[4] || '',
    instagram: row[5] || '',
    avisGoogle: row[8] !== '' ? row[8] : '',
    noteGoogle: row[9] !== '' ? row[9] : '',
    statut: row[10] || '',
    dateContact: row[11] ? formatDateFromExcel(row[11]) : '',
    notes: row[12] || ''
  })).filter(p => p.cabinet || p.praticien || p.email);

  saveData();
  showDashboard();
  toast('‚úÖ Fichier import√© ‚Äî ' + prospects.length + ' prospects charg√©s', 'success');
}

function formatDateFromExcel(val) {
  if (!val) return '';
  if (typeof val === 'number') {
    // Excel serial date
    const date = new Date((val - 25569) * 86400 * 1000);
    return date.toISOString().split('T')[0];
  }
  if (typeof val === 'string' && val.match(/\d{4}-\d{2}-\d{2}/)) return val;
  return String(val);
}

function loadDemo() {
  // Load the actual prospects from the Excel data we already know
  prospects = [
    { id: 0, cabinet: '', praticien: 'Dr Novet Thibaut', ville: 'Grenoble', email: 'secretariat.scmdentistes38@outlook.fr', telephone: '04 76 50 40 90', avisGoogle: 42, noteGoogle: 4.1, statut: '', dateContact: '', notes: '' },
    { id: 1, cabinet: '', praticien: 'Roger Dick', ville: 'Gif-sur-Yvette', email: 'secretariat.drdick@free.fr', telephone: '01 60 12 27 58', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 2, cabinet: 'Orthodontiste Montmartre', praticien: 'Jean-Marc BELLAICHE', ville: 'Paris 18', email: 'orthomontmartre@orange.fr', telephone: '01 53 28 53 28', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 3, cabinet: 'Cabinet Dentaire', praticien: 'Jawish Edouard', ville: 'Paris 14', email: 'dr.edouardjawish@gmail.com', telephone: '01 40 44 67 81', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 4, cabinet: 'Centre Dentaire du Ch√¢teau 34', praticien: 'Tony Bassil', ville: 'Paris 10', email: 'contact@centre-dentaire-du-chateau.com', telephone: '01 48 00 01 01', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 5, cabinet: '', praticien: 'Boutboul Patrick', ville: 'Saint-√âgr√®ve', email: 'cabinet.boutboul@laposte.net', telephone: '04 76 75 27 15', avisGoogle: 66, noteGoogle: 4.5, statut: '', dateContact: '', notes: '' },
    { id: 6, cabinet: '', praticien: 'Thibault Lacroix', ville: 'Grenoble', email: '', telephone: '04 38 02 00 47', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 7, cabinet: 'DR THAI & ASSOCI√âS', praticien: 'DR THAI & ASSOCI√âS', ville: 'Gif-sur-Yvette', email: '', telephone: '01 60 12 45 55', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 8, cabinet: 'Cabinet Dentaire', praticien: 'Denis CATTAN', ville: 'Paris 14', email: '', telephone: '01 43 20 27 24', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
    { id: 9, cabinet: 'Chirurgien Dentiste', praticien: 'Richard LEVY', ville: 'Paris 13', email: '', telephone: '01 45 70 77 56', avisGoogle: '', noteGoogle: '', statut: '', dateContact: '', notes: '' },
  ];
  saveData();
  showDashboard();
  toast('‚úÖ Donn√©es de d√©mo charg√©es', 'success');
}

// ============================================================
// DASHBOARD
// ============================================================
function showDashboard() {
  document.getElementById('upload-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('btn-export').style.display = 'inline-flex';
  document.getElementById('btn-reset').style.display = 'inline-flex';
  populateCityFilter();
  updateKPIs();
  renderChart();
  renderTable(prospects);
  checkUrgentNotifications();
}

function updateKPIs() {
  const total = prospects.length;
  const contacted = prospects.filter(p => p.statut && p.statut !== '√Ä contacter').length;
  const urgent = prospects.filter(p => getRelanceStatus(p) === 'late' || getRelanceStatus(p) === 'today').length;
  const discussion = prospects.filter(p => p.statut === 'En discussion').length;
  const rdv = prospects.filter(p => p.statut === 'Rendez-vous pris').length;
  const responded = prospects.filter(p => ['En discussion', 'Rendez-vous pris', 'Pas int√©ress√©'].includes(p.statut)).length;
  const rate = contacted > 0 ? Math.round((responded / contacted) * 100) : 0;

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-contacted').textContent = contacted;
  document.getElementById('kpi-urgent').textContent = urgent;
  document.getElementById('kpi-discussion').textContent = discussion;
  document.getElementById('kpi-rdv').textContent = rdv;
  document.getElementById('kpi-rate').textContent = rate + '%';

  // Update urgency badge
  const badge = document.getElementById('urgency-badge');
  document.getElementById('urgency-count').textContent = urgent;
  badge.style.display = urgent > 0 ? 'inline-flex' : 'none';

  // Update tab title
  document.title = urgent > 0 ? `(${urgent}) Horo AI ‚Äî Prospection` : 'Horo AI ‚Äî Prospection';
}

function renderChart() {
  const statusCounts = {};
  STATUSES.forEach(s => { statusCounts[s] = 0; });
  prospects.forEach(p => {
    const emoji = VALUE_TO_EMOJI[p.statut] || 'üîµ √Ä contacter';
    statusCounts[emoji] = (statusCounts[emoji] || 0) + 1;
  });

  const labels = Object.keys(statusCounts).filter(k => statusCounts[k] > 0);
  const values = labels.map(k => statusCounts[k]);
  const colors = ['#4f46e5','#6c63ff','#a78bfa','#f59e0b','#10b981','#059669','#ef4444','#6b7280'];

  if (chart) chart.destroy();
  const ctx = document.getElementById('statusChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors.slice(0, labels.length),
        borderWidth: 0,
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#6b6890',
            font: { family: 'DM Mono', size: 10 },
            padding: 8,
            boxWidth: 10
          }
        }
      },
      cutout: '65%'
    }
  });
}

function populateCityFilter() {
  const cities = [...new Set(prospects.map(p => p.ville).filter(Boolean))].sort();
  const sel = document.getElementById('filter-city');
  sel.innerHTML = '<option value="">Toutes les villes</option>';
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });
}

// ============================================================
// TABLE RENDER
// ============================================================
function renderTable(data) {
  const tbody = document.getElementById('prospects-tbody');
  const emptyState = document.getElementById('empty-state');
  document.getElementById('table-count').textContent = data.length + ' prospect' + (data.length !== 1 ? 's' : '');

  if (data.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';

  tbody.innerHTML = data.map(p => {
    const relance = getRelanceStatus(p);
    const relanceBadge = getRelanceBadge(p, relance);
    const currentStatus = p.statut || '';
    const emailBtn = p.email
      ? `<button class="btn-email" onclick="openEmail(${p.id}, event)">‚úâÔ∏è √âcrire</button>`
      : `<span class="no-email">‚Äî</span>`;

    const googleInfo = p.noteGoogle ? `‚≠ê ${p.noteGoogle} (${p.avisGoogle})` : '‚Äî';

    return `<tr onclick="openHistory(${p.id})">
      <td>
        <div class="td-name">${p.cabinet || p.praticien || '‚Äî'}</div>
        ${p.cabinet && p.praticien !== p.cabinet ? `<div class="td-sub">${p.praticien}</div>` : ''}
      </td>
      <td><span style="color:var(--muted);font-size:0.75rem">${p.ville || '‚Äî'}</span></td>
      <td>
        <div style="font-size:0.72rem">${p.telephone || '‚Äî'}</div>
        <div style="font-size:0.68rem;color:var(--muted)">${p.email ? p.email.substring(0,22)+'‚Ä¶' : 'Pas d\'email'}</div>
      </td>
      <td style="font-size:0.72rem;color:var(--muted)">${googleInfo}</td>
      <td onclick="event.stopPropagation()">
        <select class="status-select" onchange="updateStatus(${p.id}, this.value)">
          <option value="">‚Äî Choisir ‚Äî</option>
          ${STATUSES.map(s => `<option value="${STATUS_VALUES[s]}" ${STATUS_VALUES[s] === currentStatus ? 'selected' : ''}>${s}</option>`).join('')}
        </select>
      </td>
      <td onclick="event.stopPropagation()">
        <input type="date" class="date-input" value="${p.dateContact || ''}" onchange="updateDate(${p.id}, this.value)">
      </td>
      <td>${relanceBadge}</td>
      <td onclick="event.stopPropagation()">
        <textarea class="notes-input" rows="1" placeholder="Notes‚Ä¶" onchange="updateNotes(${p.id}, this.value)">${p.notes || ''}</textarea>
      </td>
      <td onclick="event.stopPropagation()">${emailBtn}</td>
    </tr>`;
  }).join('');
}

function getRelanceStatus(p) {
  if (!p.dateContact || !p.statut) return 'none';
  const today = new Date(); today.setHours(0,0,0,0);
  const contact = new Date(p.dateContact);
  const diffDays = Math.floor((today - contact) / 86400000);

  if (p.statut === 'Email J0 envoy√©') {
    if (diffDays > 3) return 'late';
    if (diffDays === 3) return 'today';
    if (diffDays < 3) return 'ok';
  }
  if (p.statut === 'Relance J3 √† faire' || p.statut === 'Relance J7 √† faire') {
    const target = p.statut.includes('J3') ? 3 : 7;
    if (diffDays > target) return 'late';
    if (diffDays === target) return 'today';
    if (diffDays < target) return 'ok';
  }
  return 'none';
}

function getRelanceBadge(p, relance) {
  if (relance === 'none') return '<span class="relance-badge none">‚Äî</span>';
  const today = new Date(); today.setHours(0,0,0,0);
  const contact = new Date(p.dateContact);
  const diffDays = Math.floor((today - contact) / 86400000);
  const target = p.statut === 'Email J0 envoy√©' ? 3 : (p.statut.includes('J3') ? 3 : 7);
  const remaining = target - diffDays;

  if (relance === 'late') return `<span class="relance-badge late">üî¥ ${Math.abs(remaining)}j de retard</span>`;
  if (relance === 'today') return `<span class="relance-badge today">üü† Aujourd'hui</span>`;
  if (relance === 'ok') return `<span class="relance-badge ok">‚úì J+${remaining}</span>`;
  return '';
}

// ============================================================
// ACTIONS
// ============================================================
function updateStatus(id, newStatus) {
  const p = prospects.find(x => x.id === id);
  if (!p) return;
  const old = p.statut;
  p.statut = newStatus;
  addHistory(id, `Statut : "${old || 'vide'}" ‚Üí "${newStatus}"`);
  saveData();
  updateKPIs();
  renderChart();
  applyFilters();
  toast('Statut mis √† jour', 'success');
}

function updateDate(id, val) {
  const p = prospects.find(x => x.id === id);
  if (!p) return;
  p.dateContact = val;
  addHistory(id, `Date de contact : ${val}`);
  saveData();
  updateKPIs();
  applyFilters();
}

function updateNotes(id, val) {
  const p = prospects.find(x => x.id === id);
  if (!p) return;
  p.notes = val;
  saveData();
}

function openEmail(id, event) {
  event.stopPropagation();
  const p = prospects.find(x => x.id === id);
  if (!p || !p.email) return;

  // Auto-fill date if empty
  if (!p.dateContact) {
    p.dateContact = new Date().toISOString().split('T')[0];
    addHistory(id, `Date de contact auto-remplie : ${p.dateContact}`);
    saveData();
    applyFilters();
  }

  const subject = encodeURIComponent(`Horo AI ‚Äî R√©ceptionniste IA Vocale | ${p.cabinet || p.praticien}`);
  window.location.href = `mailto:${p.email}?subject=${subject}`;
  toast(`‚úâÔ∏è Email ouvert pour ${p.praticien}`, 'success');
}

// ============================================================
// HISTORY
// ============================================================
function addHistory(id, text) {
  if (!history[id]) history[id] = [];
  const now = new Date();
  const time = now.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' }) + ' ' + now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
  history[id].unshift({ time, text });
  localStorage.setItem('horo_history', JSON.stringify(history));
}

function openHistory(id) {
  const p = prospects.find(x => x.id === id);
  if (!p) return;
  document.getElementById('modal-prospect-name').textContent = p.cabinet || p.praticien || 'Prospect';
  document.getElementById('modal-prospect-sub').textContent = p.ville + (p.email ? ' ¬∑ ' + p.email : '');

  const list = document.getElementById('history-list');
  const entries = history[id] || [];
  if (entries.length === 0) {
    list.innerHTML = '<div class="empty-history">Aucune activit√© enregistr√©e.<br>Modifie le statut ou la date pour commencer.</div>';
  } else {
    list.innerHTML = entries.map(e => `
      <div class="history-item">
        <div class="history-dot"></div>
        <div>
          <div class="history-time">${e.time}</div>
          <div class="history-text">${e.text}</div>
        </div>
      </div>
    `).join('');
  }

  document.getElementById('history-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('history-modal').classList.remove('open');
}

document.getElementById('history-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ============================================================
// FILTERS
// ============================================================
function applyFilters() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const status = document.getElementById('filter-status').value;
  const city = document.getElementById('filter-city').value;

  let filtered = prospects.filter(p => {
    const matchSearch = !search || [p.cabinet, p.praticien, p.email, p.ville].some(v => v && v.toLowerCase().includes(search));
    const matchStatus = !status || p.statut === status;
    const matchCity = !city || p.ville === city;
    const matchUrgent = !urgentFilterActive || ['late','today'].includes(getRelanceStatus(p));
    return matchSearch && matchStatus && matchCity && matchUrgent;
  });

  renderTable(filtered);
}

function toggleUrgentFilter() {
  urgentFilterActive = !urgentFilterActive;
  document.getElementById('btn-urgent-filter').classList.toggle('active', urgentFilterActive);
  applyFilters();
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function checkUrgentNotifications() {
  const urgent = prospects.filter(p => ['late','today'].includes(getRelanceStatus(p)));
  if (urgent.length > 0) {
    setTimeout(() => {
      sendNotification('Horo AI ‚Äî Relances', `üî• ${urgent.length} relance(s) √† traiter aujourd'hui`);
    }, 1000);
  }
}

// ============================================================
// EXPORT
// ============================================================
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const rows = [
    ['Nom du Cabinet', 'Nom du Praticien', 'Ville', 'Email', 'T√©l√©phone', 'Instagram', '', '', 'Avis Google', 'Note Google (/5)', 'Statut', 'Date de contact', 'Notes / Remarques']
  ];
  prospects.forEach(p => {
    rows.push([p.cabinet, p.praticien, p.ville, p.email, p.telephone, p.instagram || '', '', '', p.avisGoogle, p.noteGoogle, p.statut, p.dateContact, p.notes]);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Prospection Cabinets Dentaires');
  XLSX.writeFile(wb, 'Prospection_HoroAI_export.xlsx');
  toast('‚Üì Export Excel t√©l√©charg√©', 'success');
}

// ============================================================
// SAVE / RESET
// ============================================================
function saveData() {
  localStorage.setItem('horo_prospects', JSON.stringify(prospects));
  localStorage.setItem('horo_history', JSON.stringify(history));
}

function resetApp() {
  if (!confirm('Effacer toutes les donn√©es et recommencer ?')) return;
  localStorage.removeItem('horo_prospects');
  localStorage.removeItem('horo_history');
  prospects = []; history = {};
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('upload-screen').style.display = 'flex';
  document.getElementById('btn-export').style.display = 'none';
  document.getElementById('btn-reset').style.display = 'none';
  document.getElementById('file-input').value = '';
}

// ============================================================
// TOAST
// ============================================================
function toast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}
</script>
</body>
</html>
