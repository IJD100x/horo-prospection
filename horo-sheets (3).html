<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horo AI ‚Äî Prospection</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg: #08080f;
    --surface: #10101c;
    --card: #15152a;
    --border: #1e1e38;
    --accent: #6c63ff;
    --accent2: #a78bfa;
    --accent-glow: rgba(108,99,255,0.15);
    --text: #e8e6f0;
    --muted: #6b6890;
    --red: #ff4d6d;
    --orange: #ff9f43;
    --green: #0be881;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-mono); min-height: 100vh; overflow-x: hidden; }
  body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; }

  /* LOGIN */
  #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; position: relative; z-index: 1; }
  .login-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 3rem 3.5rem; max-width: 420px; width: 90%; text-align: center; position: relative; overflow: hidden; }
  .login-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .login-logo { font-family: var(--font-head); font-size: 2rem; font-weight: 800; letter-spacing: -0.04em; margin-bottom: 0.4rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
  .login-logo span { color: var(--accent2); }
  .login-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 12px var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
  .login-sub { color: var(--muted); font-size: 0.8rem; margin-bottom: 2.5rem; line-height: 1.7; }
  .btn-google { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; background: white; color: #1f2937; border: none; padding: 13px 24px; border-radius: 10px; font-family: var(--font-head); font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 12px rgba(0,0,0,0.4); }
  .btn-google:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.5); }
  .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }
  .login-note { margin-top: 1.25rem; font-family: var(--font-head); font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; color: var(--accent2); }
  .login-note span { display: block; font-family: var(--font-mono); font-size: 0.65rem; font-weight: 400; color: var(--muted); letter-spacing: 0.08em; margin-top: 4px; text-transform: uppercase; }
  .login-error { display: none; margin-top: 1rem; background: rgba(255,77,109,0.1); border: 1px solid rgba(255,77,109,0.3); border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.75rem; color: var(--red); }
  .login-error.show { display: block; }

  /* HEADER */
  header { position: sticky; top: 0; z-index: 100; background: rgba(8,8,15,0.92); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 60px; }
  .logo { font-family: var(--font-head); font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; display: flex; align-items: center; gap: 0.5rem; }
  .logo span { color: var(--accent2); }
  .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 2s infinite; }
  .header-right { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  #urgency-badge { display: none; background: var(--red); color: white; font-family: var(--font-head); font-weight: 700; font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; animation: flash 1.5s infinite; }
  @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.7} }
  .sync-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.72rem; padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); }
  .sync-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .sync-dot.syncing { background: var(--orange); animation: pulse 1s infinite; }
  .sync-dot.error { background: var(--red); }
  .user-chip { display: flex; align-items: center; gap: 0.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 5px 12px; font-size: 0.72rem; color: var(--muted); }
  .user-chip-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }
  .btn-logout { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 0.7rem; margin-left: 4px; transition: color 0.2s; }
  .btn-logout:hover { color: var(--red); }

  /* MAIN */
  main { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem; }
  .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-family: var(--font-head); font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
  .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(108,99,255,0.4); }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; font-family: var(--font-mono); font-size: 0.78rem; cursor: pointer; transition: all 0.2s; }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent2); }
  .btn-email { background: rgba(108,99,255,0.12); color: var(--accent2); border: 1px solid rgba(108,99,255,0.3); padding: 5px 10px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; font-family: var(--font-mono); }
  .btn-email:hover { background: rgba(108,99,255,0.25); border-color: var(--accent); }

  /* LOADING */
  #loading-screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; gap: 1rem; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--muted); font-size: 0.82rem; }

  #dashboard { display: none; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
  .page-title { font-family: var(--font-head); font-size: 1.4rem; font-weight: 800; letter-spacing: -0.03em; }
  .page-title span { color: var(--accent2); }
  .top-actions { display: flex; gap: 0.75rem; align-items: center; }

  /* AUTO SYNC BANNER */
  .auto-banner { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
  .auto-banner-left { display: flex; align-items: center; gap: 0.75rem; font-size: 0.78rem; }
  .auto-banner-title { font-family: var(--font-head); font-weight: 700; font-size: 0.82rem; }
  .auto-banner-sub { color: var(--muted); font-size: 0.72rem; margin-top: 2px; }
  .auto-banner-actions { display: flex; gap: 0.5rem; align-items: center; }

  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; position: relative; overflow: hidden; transition: border-color 0.2s; }
  .kpi-card:hover { border-color: var(--accent); }
  .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent), var(--accent2)); opacity: 0; transition: opacity 0.2s; }
  .kpi-card:hover::after { opacity: 1; }
  .kpi-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem; }
  .kpi-value { font-family: var(--font-head); font-size: 2rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1; }
  .kpi-value.accent { color: var(--accent2); }
  .kpi-value.red { color: var(--red); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.orange { color: var(--orange); }

  .mid-section { display: grid; grid-template-columns: 260px 1fr; gap: 1rem; margin-bottom: 2rem; }
  .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
  .card-title { font-family: var(--font-head); font-size: 0.8rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 1rem; }
  .filters-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
  .filters-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
  .search-input { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font-mono); font-size: 0.8rem; padding: 8px 14px; flex: 1; min-width: 180px; transition: border-color 0.2s; outline: none; }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }
  select.filter-select { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font-mono); font-size: 0.78rem; padding: 8px 12px; cursor: pointer; outline: none; transition: border-color 0.2s; appearance: none; padding-right: 28px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b6890' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }
  select.filter-select:focus { border-color: var(--accent); }
  .filter-btn { background: rgba(255,77,109,0.1); color: var(--red); border: 1px solid rgba(255,77,109,0.3); padding: 8px 14px; border-radius: 8px; font-family: var(--font-mono); font-size: 0.78rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .filter-btn:hover, .filter-btn.active { background: rgba(255,77,109,0.2); border-color: var(--red); }

  .table-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .table-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .table-count { font-size: 0.75rem; color: var(--muted); }
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
  thead th { background: var(--surface); padding: 10px 12px; text-align: left; font-family: var(--font-head); font-size: 0.68rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; white-space: nowrap; border-bottom: 1px solid var(--border); }
  tbody tr { border-bottom: 1px solid rgba(30,30,56,0.6); transition: background 0.15s; cursor: pointer; }
  tbody tr:hover { background: rgba(108,99,255,0.05); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 10px 12px; vertical-align: middle; white-space: nowrap; }
  .td-name { font-family: var(--font-head); font-weight: 600; font-size: 0.82rem; }
  .td-sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  .status-select { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: var(--font-mono); font-size: 0.72rem; padding: 4px 8px; cursor: pointer; outline: none; transition: all 0.2s; max-width: 180px; appearance: none; padding-right: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' fill='none'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%236b6890' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; }
  .status-select:focus { border-color: var(--accent); }

  .relance-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 0.68rem; font-weight: 500; white-space: nowrap; }
  .relance-badge.late { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
  .relance-badge.today { background: rgba(255,159,67,0.15); color: var(--orange); border: 1px solid rgba(255,159,67,0.3); }
  .relance-badge.ok { background: rgba(11,232,129,0.1); color: var(--green); border: 1px solid rgba(11,232,129,0.2); }
  .relance-badge.none { color: var(--muted); font-size: 0.65rem; }
  .replied-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 0.68rem; background: rgba(11,232,129,0.1); color: var(--green); border: 1px solid rgba(11,232,129,0.2); }
  .bounce-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 0.68rem; background: rgba(255,77,109,0.1); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }

  .date-input { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: var(--font-mono); font-size: 0.72rem; padding: 4px 8px; cursor: pointer; outline: none; transition: border-color 0.2s; width: 120px; }
  .date-input:focus { border-color: var(--accent); }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
  .notes-input { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: var(--font-mono); font-size: 0.72rem; padding: 4px 8px; outline: none; transition: border-color 0.2s; width: 150px; resize: none; }
  .notes-input:focus { border-color: var(--accent); }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
  .modal-title { font-family: var(--font-head); font-size: 1.1rem; font-weight: 800; margin-bottom: 0.25rem; }
  .modal-sub { color: var(--muted); font-size: 0.75rem; margin-bottom: 1.5rem; }
  .modal-close { position: absolute; top: 1.25rem; right: 1.25rem; background: var(--surface); border: 1px solid var(--border); color: var(--muted); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .modal-close:hover { color: var(--text); border-color: var(--accent); }
  .history-list { display: flex; flex-direction: column; gap: 0.75rem; }
  .history-item { display: flex; gap: 0.75rem; align-items: flex-start; font-size: 0.78rem; }
  .history-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; flex-shrink: 0; margin-top: 4px; box-shadow: 0 0 6px var(--accent); }
  .history-time { color: var(--muted); font-size: 0.68rem; white-space: nowrap; }
  .history-text { color: var(--text); line-height: 1.5; }
  .empty-history { color: var(--muted); font-size: 0.78rem; text-align: center; padding: 2rem 0; }

  #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
  .toast { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.78rem; max-width: 300px; animation: slideIn 0.3s ease; border-left: 3px solid var(--accent); }
  .toast.success { border-left-color: var(--green); }
  .toast.warning { border-left-color: var(--orange); }
  .toast.error { border-left-color: var(--red); }
  @keyframes slideIn { from{transform:translateX(100px);opacity:0} to{transform:translateX(0);opacity:1} }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
  .empty-state { text-align: center; padding: 3rem; color: var(--muted); font-size: 0.82rem; }
  .no-email { color: var(--muted); font-size: 0.7rem; font-style: italic; }

  @media (max-width: 900px) { .mid-section { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 600px) { main { padding: 1rem; } .kpi-grid { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo"><div class="login-dot"></div>Horo<span>AI</span></div>
    <div class="login-sub">Suivi de prospection ‚Äî Cabinets Dentaires<br>Acc√®s r√©serv√© √† l'√©quipe Horo AI</div>
    <button class="btn-google" onclick="loginWithGoogle()">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Se connecter avec Google
    </button>
    <div class="login-error" id="login-error">‚ùå Acc√®s refus√©. Seuls les comptes <strong>@horoai.fr</strong> sont autoris√©s.</div>
    <p class="login-note">1% Better<span>Every. Single. Day.</span></p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">

<header>
  <div class="logo"><div class="logo-dot"></div>Horo<span>AI</span> ‚Äî Prospection</div>
  <div class="header-right">
    <span id="urgency-badge">üî• <span id="urgency-count">0</span> relances urgentes</span>
    <div class="sync-status" id="sync-status">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-text">Sheets</span>
    </div>
    <div class="user-chip">
      <div class="user-chip-dot"></div>
      <span id="user-email-display"></span>
      <button class="btn-logout" onclick="logout()">‚úï</button>
    </div>
    <button class="btn-ghost" id="btn-reset" style="display:none" onclick="resetApp()">‚Ü∫ Reset</button>
  </div>
</header>

<main>
  <div id="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Chargement depuis Google Sheets...</div>
  </div>

  <div id="dashboard">
    <div class="top-bar">
      <div class="page-title">Cabinets <span>Dentaires</span></div>
      <div class="top-actions">
        <button class="btn-ghost" onclick="syncFromSheets()">‚Üì Sync Sheets</button>
        <button class="btn-primary" onclick="runAutoScan()">‚ö° Scan auto</button>
      </div>
    </div>

    <!-- AUTO BANNER -->
    <div class="auto-banner">
      <div class="auto-banner-left">
        <div style="font-size:1.4rem">‚ö°</div>
        <div>
          <div class="auto-banner-title">Automatisation active</div>
          <div class="auto-banner-sub" id="last-auto-scan">Clique "Scan auto" pour d√©tecter les r√©ponses et bounces + mettre √† jour les statuts J3/J7</div>
        </div>
      </div>
      <div class="auto-banner-actions">
        <div id="auto-scan-result" style="font-size:0.72rem;color:var(--muted)"></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">Total</div><div class="kpi-value accent" id="kpi-total">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Contact√©s</div><div class="kpi-value" id="kpi-contacted">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Relances urgentes</div><div class="kpi-value red" id="kpi-urgent">0</div></div>
      <div class="kpi-card"><div class="kpi-label">En discussion</div><div class="kpi-value orange" id="kpi-discussion">0</div></div>
      <div class="kpi-card"><div class="kpi-label">RDV pris</div><div class="kpi-value green" id="kpi-rdv">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Invalides</div><div class="kpi-value red" id="kpi-invalid">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Taux r√©ponse</div><div class="kpi-value accent" id="kpi-rate">0%</div></div>
    </div>

    <!-- CHART + FILTERS -->
    <div class="mid-section">
      <div class="chart-card"><div class="card-title">R√©partition</div><canvas id="statusChart" height="220"></canvas></div>
      <div class="filters-card">
        <div class="card-title">Filtres & Recherche</div>
        <div class="filters-row">
          <input type="text" class="search-input" id="search-input" placeholder="üîç Nom, ville, email..." oninput="applyFilters()">
          <select class="filter-select" id="filter-status" onchange="applyFilters()">
            <option value="">Tous les statuts</option>
            <option value="√Ä contacter">üîµ √Ä contacter</option>
            <option value="Email J0 envoy√©">üì§ Email J0 envoy√©</option>
            <option value="Relance J3 √† faire">üîÑ Relance J3</option>
            <option value="Relance J7 √† faire">üîÑ Relance J7</option>
            <option value="En discussion">üí¨ En discussion</option>
            <option value="Rendez-vous pris">‚úÖ RDV pris</option>
            <option value="Pas int√©ress√©">‚ùå Pas int√©ress√©</option>
            <option value="Sans r√©ponse">üö´ Sans r√©ponse</option>
            <option value="Email invalide">üìß Email invalide</option>
          </select>
          <select class="filter-select" id="filter-city" onchange="applyFilters()">
            <option value="">Toutes les villes</option>
          </select>
          <button class="filter-btn" id="btn-urgent-filter" onclick="toggleUrgentFilter()">üî• Relances du jour</button>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-card">
      <div class="table-header">
        <div class="card-title" style="margin:0">Prospects</div>
        <div class="table-count" id="table-count">0 prospects</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Cabinet / Praticien</th><th>Ville</th><th>Contact</th><th>Google</th><th>Statut</th><th>Date contact</th><th>Prochaine action</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="prospects-tbody"></tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display:none">Aucun prospect trouv√©.</div>
      </div>
    </div>
  </div>
</main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="history-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modal-prospect-name"></div>
    <div class="modal-sub" id="modal-prospect-sub"></div>
    <div class="history-list" id="history-list"></div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const GOOGLE_CLIENT_ID = '545051927583-0mog40ni8g3r8ectughk072p0j2dlvud.apps.googleusercontent.com';
const ALLOWED_DOMAIN = 'horoai.fr';
const SHEET_ID = '1uv3LXzQ_CoazQrIHUVTim8M7uCZR-M8b4iqpdScZBgg';
const SHEET_NAME = 'Prospection Cabinets Dentaires';
const SHEET_NAME_ENCODED = SHEET_NAME.replace(/ /g, '%20');
const SCOPES = [
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/spreadsheets',
  'https://www.googleapis.com/auth/gmail.readonly'
].join(' ');

// BOUNCE KEYWORDS ‚Äî emails qui indiquent un bounce
const BOUNCE_KEYWORDS = [
  'mailer-daemon', 'postmaster', 'delivery failed', 'undeliverable',
  'mail delivery failed', '√©chec de livraison', 'address not found',
  'user unknown', 'no such user', 'invalid address', 'bounce',
  'returned mail', 'non-delivery', 'delivery status notification'
];

let prospects = [], history = {}, chart = null;
let urgentFilterActive = false;
let accessToken = null, currentUser = null;

const STATUSES = ['üîµ √Ä contacter','üì§ Email J0 envoy√©','üîÑ Relance J3 √† faire','üîÑ Relance J7 √† faire','üí¨ En discussion','‚úÖ Rendez-vous pris','‚ùå Pas int√©ress√©','üö´ Sans r√©ponse','üìß Email invalide'];
const STATUS_VALUES = {'üîµ √Ä contacter':'√Ä contacter','üì§ Email J0 envoy√©':'Email J0 envoy√©','üîÑ Relance J3 √† faire':'Relance J3 √† faire','üîÑ Relance J7 √† faire':'Relance J7 √† faire','üí¨ En discussion':'En discussion','‚úÖ Rendez-vous pris':'Rendez-vous pris','‚ùå Pas int√©ress√©':'Pas int√©ress√©','üö´ Sans r√©ponse':'Sans r√©ponse','üìß Email invalide':'Email invalide'};
const VALUE_TO_EMOJI = {};
Object.entries(STATUS_VALUES).forEach(([k,v]) => VALUE_TO_EMOJI[v]=k);

// ROW MAPPING (colonnes dans le Sheet, 0-indexed)
const COL = { cabinet:0, praticien:1, ville:2, email:3, telephone:4, instagram:5, facebook:6, linkedin:7, avisGoogle:8, noteGoogle:9, statut:10, dateContact:11, notes:12 };
const HEADER_ROW = 3; // ligne 3 = en-t√™tes (0-indexed), donn√©es √† partir de ligne 4

// ============================================================
// AUTH
// ============================================================
window.onload = () => {
  const saved = localStorage.getItem('horo_user');
  if (saved) {
    currentUser = JSON.parse(saved);
    // Need fresh token ‚Äî re-authenticate silently
    authenticateSilently();
  }
};

function loginWithGoogle() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: async (response) => {
      if (response.error) { showLoginError(); return; }
      accessToken = response.access_token;
      try {
        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': 'Bearer ' + accessToken } });
        const user = await res.json();
        if (user.email.split('@')[1] !== ALLOWED_DOMAIN) { showLoginError(); return; }
        currentUser = { email: user.email, name: user.name };
        localStorage.setItem('horo_user', JSON.stringify(currentUser));
        showApp();
      } catch(e) { showLoginError(); }
    }
  });
  client.requestAccessToken();
}

function authenticateSilently() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    prompt: '',
    callback: async (response) => {
      if (response.error || !response.access_token) {
        // Need full login
        localStorage.removeItem('horo_user');
        return;
      }
      accessToken = response.access_token;
      showApp();
    }
  });
  client.requestAccessToken();
}

function showLoginError() {
  document.getElementById('login-error').classList.add('show');
  setTimeout(() => document.getElementById('login-error').classList.remove('show'), 4000);
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('user-email-display').textContent = currentUser.email;
  document.getElementById('btn-reset').style.display = 'inline-flex';
  history = JSON.parse(localStorage.getItem('horo_history') || '{}');
  requestNotificationPermission();
  loadFromSheets();
}

function logout() {
  if (!confirm('Se d√©connecter ?')) return;
  localStorage.removeItem('horo_user');
  currentUser = null; accessToken = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
}
function sendNotification(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') new Notification(title, { body });
}

// ============================================================
// GOOGLE SHEETS ‚Äî READ
// ============================================================
async function loadFromSheets() {
  document.getElementById('loading-screen').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  setSyncStatus('syncing', 'Chargement...');
  try {
    const range = `${SHEET_NAME_ENCODED}!A1:M200`;
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}`, {
      headers: { 'Authorization': 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    parseSheetData(data.values || []);
    setSyncStatus('ok', 'Synchronis√©');
    toast('‚úÖ Donn√©es charg√©es depuis Google Sheets', 'success');
  } catch(e) {
    setSyncStatus('error', 'Erreur Sheets');
    toast('‚ùå Erreur Sheets : ' + e.message, 'error');
  }
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  populateCityFilter(); updateKPIs(); renderChart(); renderTable(prospects);
  autoUpdateStatuses();
  checkUrgentNotifications();
}

async function syncFromSheets() {
  setSyncStatus('syncing', 'Sync...');
  try {
    const range = `${SHEET_NAME_ENCODED}!A1:M200`;
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}`, {
      headers: { 'Authorization': 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    parseSheetData(data.values || []);
    setSyncStatus('ok', 'Synchronis√©');
    populateCityFilter(); updateKPIs(); renderChart(); applyFilters();
    autoUpdateStatuses();
    toast('‚úÖ Synchronis√© depuis Google Sheets', 'success');
  } catch(e) {
    setSyncStatus('error', 'Erreur');
    toast('‚ùå Erreur sync : ' + e.message, 'error');
  }
}

function parseSheetData(rows) {
  // Header is on row 3 (index 2), data starts row 4 (index 3)
  const dataRows = rows.slice(HEADER_ROW).filter(row => row.some(c => c && c !== ''));
  prospects = dataRows.map((row, i) => ({
    id: i,
    rowIndex: HEADER_ROW + 1 + i, // 1-indexed: header=ligne3, donn√©es=ligne4+ (3+1+0=4 pour le premier)
    cabinet: row[COL.cabinet] || '',
    praticien: row[COL.praticien] || '',
    ville: row[COL.ville] || '',
    email: row[COL.email] || '',
    telephone: row[COL.telephone] || '',
    avisGoogle: row[COL.avisGoogle] || '',
    noteGoogle: row[COL.noteGoogle] || '',
    statut: row[COL.statut] || '',
    dateContact: row[COL.dateContact] || '',
    notes: row[COL.notes] || ''
  })).filter(p => p.cabinet || p.praticien || p.email);
}

// ============================================================
// GOOGLE SHEETS ‚Äî WRITE
// ============================================================
async function updateSheetRow(prospect, fields) {
  setSyncStatus('syncing', 'Sauvegarde...');
  try {
    // Build updates per field
    const updates = [];
    if (fields.includes('statut')) updates.push({ range: `${SHEET_NAME}!K${prospect.rowIndex}`, values: [[prospect.statut]] });
    if (fields.includes('dateContact')) updates.push({ range: `${SHEET_NAME}!L${prospect.rowIndex}`, values: [[prospect.dateContact]] });
    if (fields.includes('notes')) updates.push({ range: `${SHEET_NAME}!M${prospect.rowIndex}`, values: [[prospect.notes]] });

    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchUpdate`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
      body: JSON.stringify({ valueInputOption: 'RAW', data: updates })
    });
    setSyncStatus('ok', 'Synchronis√©');
  } catch(e) {
    setSyncStatus('error', 'Erreur sauvegarde');
    toast('‚ùå Erreur sauvegarde : ' + e.message, 'error');
  }
}

function setSyncStatus(state, text) {
  const dot = document.getElementById('sync-dot');
  document.getElementById('sync-text').textContent = text;
  dot.className = 'sync-dot' + (state === 'ok' ? ' ok' : state === 'syncing' ? ' syncing' : state === 'error' ? ' error' : '');
}

// ============================================================
// AUTO STATUS UPDATE (J3/J7 bas√© sur les dates)
// ============================================================
function autoUpdateStatuses() {
  let updated = 0;
  const today = new Date(); today.setHours(0,0,0,0);

  prospects.forEach(p => {
    if (!p.dateContact) return;
    const diff = Math.floor((today - new Date(p.dateContact)) / 86400000);
    let newStatut = null;

    if (p.statut === 'Email J0 envoy√©' && diff >= 3) newStatut = 'Relance J3 √† faire';
    else if (p.statut === 'Relance J3 √† faire' && diff >= 7) newStatut = 'Relance J7 √† faire';

    if (newStatut) {
      const old = p.statut;
      p.statut = newStatut;
      addHistory(p.id, `‚ö° Auto ‚Äî Statut : "${old}" ‚Üí "${newStatut}"`);
      updateSheetRow(p, ['statut']);
      updated++;
    }
  });

  if (updated > 0) {
    updateKPIs(); renderChart(); applyFilters();
    toast(`‚ö° ${updated} statut(s) mis √† jour automatiquement`, 'success');
  }
}

// ============================================================
// AUTO SCAN GMAIL (r√©ponses + bounces)
// ============================================================
async function runAutoScan() {
  if (!accessToken) { toast('Token expir√©, reconnecte-toi', 'warning'); return; }

  const btn = document.querySelector('[onclick="runAutoScan()"]');
  btn.textContent = '‚è≥ Scan...'; btn.disabled = true;

  let repliesFound = 0, bouncesFound = 0;

  try {
    // Fetch recent emails
    const res = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent('in:inbox newer_than:30d')}&maxResults=100`, {
      headers: { 'Authorization': 'Bearer ' + accessToken }
    });
    const data = await res.json();

    if (!data.messages) { toast('Aucun email trouv√© dans les 30 derniers jours'); btn.textContent = '‚ö° Scan auto'; btn.disabled = false; return; }

    // Fetch message details
    const details = await Promise.all(data.messages.slice(0, 80).map(async msg => {
      const r = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=To`, {
        headers: { 'Authorization': 'Bearer ' + accessToken }
      });
      return r.json();
    }));

    const prospectEmails = prospects.filter(p => p.email).map(p => ({ id: p.id, email: p.email.toLowerCase() }));

    details.forEach(msg => {
      const headers = msg.payload?.headers || [];
      const from = (headers.find(h => h.name === 'From')?.value || '').toLowerCase();
      const subject = (headers.find(h => h.name === 'Subject')?.value || '').toLowerCase();
      const to = (headers.find(h => h.name === 'To')?.value || '').toLowerCase();

      // Check for bounce
      const isBounce = BOUNCE_KEYWORDS.some(k => from.includes(k) || subject.includes(k));

      if (isBounce) {
        // Try to find which prospect bounced by checking the "To" field or subject
        prospectEmails.forEach(pe => {
          if (to.includes(pe.email) || subject.includes(pe.email)) {
            const p = prospects.find(x => x.id === pe.id);
            if (p && p.statut !== 'Email invalide') {
              const old = p.statut;
              p.statut = 'Email invalide';
              addHistory(p.id, `üìß Bounce d√©tect√© automatiquement ‚Äî Statut : "${old}" ‚Üí "Email invalide"`);
              updateSheetRow(p, ['statut']);
              bouncesFound++;
            }
          }
        });
        return;
      }

      // Check for reply from prospect
      const emailMatch = from.match(/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/);
      if (emailMatch) {
        const senderEmail = emailMatch[0].toLowerCase();
        const match = prospectEmails.find(pe => pe.email === senderEmail);
        if (match) {
          const p = prospects.find(x => x.id === match.id);
          if (p && !['En discussion', 'Rendez-vous pris', 'Pas int√©ress√©'].includes(p.statut)) {
            const old = p.statut;
            p.statut = 'En discussion';
            addHistory(p.id, `üì¨ R√©ponse d√©tect√©e automatiquement ‚Äî Statut : "${old}" ‚Üí "En discussion"`);
            updateSheetRow(p, ['statut']);
            repliesFound++;
          }
        }
      }
    });

    // Also run date-based auto update
    autoUpdateStatuses();

    updateKPIs(); renderChart(); applyFilters();

    const now = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
    const summary = `Dernier scan : ${now} ‚Äî ${repliesFound} r√©ponse(s), ${bouncesFound} bounce(s) d√©tect√©(s)`;
    document.getElementById('last-auto-scan').textContent = summary;
    document.getElementById('auto-scan-result').textContent = `‚úÖ ${repliesFound + bouncesFound} mise(s) √† jour`;

    if (repliesFound + bouncesFound > 0) {
      sendNotification('Horo AI ‚Äî Scan termin√©', `${repliesFound} r√©ponse(s), ${bouncesFound} bounce(s) d√©tect√©(s)`);
      toast(`‚ö° ${repliesFound} r√©ponse(s) + ${bouncesFound} bounce(s) d√©tect√©(s)`, 'success');
    } else {
      toast('‚úÖ Scan termin√© ‚Äî aucun changement');
    }

  } catch(e) {
    toast('‚ùå Erreur scan : ' + e.message, 'error');
  }

  btn.textContent = '‚ö° Scan auto'; btn.disabled = false;
}

// ============================================================
// DASHBOARD
// ============================================================
function updateKPIs() {
  const total = prospects.length;
  const contacted = prospects.filter(p => p.statut && p.statut !== '√Ä contacter').length;
  const urgent = prospects.filter(p => ['late','today'].includes(getRelanceStatus(p))).length;
  const discussion = prospects.filter(p => p.statut === 'En discussion').length;
  const rdv = prospects.filter(p => p.statut === 'Rendez-vous pris').length;
  const invalid = prospects.filter(p => p.statut === 'Email invalide').length;
  const responded = prospects.filter(p => ['En discussion','Rendez-vous pris','Pas int√©ress√©'].includes(p.statut)).length;
  const rate = contacted > 0 ? Math.round((responded/contacted)*100) : 0;
  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-contacted').textContent = contacted;
  document.getElementById('kpi-urgent').textContent = urgent;
  document.getElementById('kpi-discussion').textContent = discussion;
  document.getElementById('kpi-rdv').textContent = rdv;
  document.getElementById('kpi-invalid').textContent = invalid;
  document.getElementById('kpi-rate').textContent = rate + '%';
  const badge = document.getElementById('urgency-badge');
  document.getElementById('urgency-count').textContent = urgent;
  badge.style.display = urgent > 0 ? 'inline-flex' : 'none';
  document.title = urgent > 0 ? `(${urgent}) Horo AI` : 'Horo AI ‚Äî Prospection';
}

function renderChart() {
  const counts = {};
  STATUSES.forEach(s => counts[s] = 0);
  prospects.forEach(p => { const e = VALUE_TO_EMOJI[p.statut]||'üîµ √Ä contacter'; counts[e] = (counts[e]||0)+1; });
  const labels = Object.keys(counts).filter(k => counts[k] > 0);
  const values = labels.map(k => counts[k]);
  const colors = ['#4f46e5','#6c63ff','#a78bfa','#f59e0b','#10b981','#059669','#ef4444','#6b7280','#dc2626'];
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('statusChart').getContext('2d'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0,labels.length), borderWidth: 0, hoverOffset: 4 }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#6b6890', font: { family: 'DM Mono', size: 10 }, padding: 8, boxWidth: 10 } } }, cutout: '65%' }
  });
}

function populateCityFilter() {
  const cities = [...new Set(prospects.map(p => p.ville).filter(Boolean))].sort();
  const sel = document.getElementById('filter-city');
  sel.innerHTML = '<option value="">Toutes les villes</option>';
  cities.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}

// ============================================================
// TABLE
// ============================================================
function renderTable(data) {
  const tbody = document.getElementById('prospects-tbody');
  const empty = document.getElementById('empty-state');
  document.getElementById('table-count').textContent = data.length + ' prospect' + (data.length!==1?'s':'');
  if (!data.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = data.map(p => {
    const relance = getRelanceStatus(p);
    const badge = getRelanceBadge(p, relance);
    const emailBtn = p.email ? `<button class="btn-email" onclick="openEmail(${p.id},event)">‚úâÔ∏è √âcrire</button>` : `<span class="no-email">‚Äî</span>`;
    const isInvalid = p.statut === 'Email invalide';
    return `<tr onclick="openHistory(${p.id})" ${isInvalid?'style="opacity:0.6"':''}>
      <td><div class="td-name">${p.cabinet||p.praticien||'‚Äî'}</div>${p.cabinet&&p.praticien!==p.cabinet?`<div class="td-sub">${p.praticien}</div>`:''}</td>
      <td><span style="color:var(--muted);font-size:0.75rem">${p.ville||'‚Äî'}</span></td>
      <td><div style="font-size:0.72rem">${p.telephone||'‚Äî'}</div><div style="font-size:0.68rem;color:${isInvalid?'var(--red)':'var(--muted)'}">${p.email?p.email.substring(0,24)+'‚Ä¶':'Pas d\'email'}${isInvalid?' ‚ö†Ô∏è':''}</div></td>
      <td style="font-size:0.72rem;color:var(--muted)">${p.noteGoogle?`‚≠ê ${p.noteGoogle} (${p.avisGoogle})`:'‚Äî'}</td>
      <td onclick="event.stopPropagation()"><select class="status-select" onchange="updateStatus(${p.id},this.value)"><option value="">‚Äî Choisir ‚Äî</option>${STATUSES.map(s=>`<option value="${STATUS_VALUES[s]}" ${STATUS_VALUES[s]===p.statut?'selected':''}>${s}</option>`).join('')}</select></td>
      <td onclick="event.stopPropagation()"><input type="date" class="date-input" value="${p.dateContact||''}" onchange="updateDate(${p.id},this.value)"></td>
      <td>${badge}</td>
      <td onclick="event.stopPropagation()"><textarea class="notes-input" rows="1" placeholder="Notes‚Ä¶" onchange="updateNotes(${p.id},this.value)">${p.notes||''}</textarea></td>
      <td onclick="event.stopPropagation()">${emailBtn}</td>
    </tr>`;
  }).join('');
}

function getRelanceStatus(p) {
  if (!p.dateContact||!p.statut) return 'none';
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.floor((today - new Date(p.dateContact)) / 86400000);
  if (p.statut==='Email J0 envoy√©') { if(diff>3)return'late'; if(diff===3)return'today'; if(diff<3)return'ok'; }
  if (p.statut==='Relance J3 √† faire'||p.statut==='Relance J7 √† faire') { const t=p.statut.includes('J3')?3:7; if(diff>t)return'late'; if(diff===t)return'today'; if(diff<t)return'ok'; }
  return 'none';
}

function getRelanceBadge(p, relance) {
  if (relance==='none') return '<span class="relance-badge none">‚Äî</span>';
  const diff = Math.floor((new Date().setHours(0,0,0,0) - new Date(p.dateContact)) / 86400000);
  const target = p.statut==='Email J0 envoy√©'?3:(p.statut.includes('J3')?3:7);
  const rem = target - diff;
  if (relance==='late') return `<span class="relance-badge late">üî¥ ${Math.abs(rem)}j retard</span>`;
  if (relance==='today') return `<span class="relance-badge today">üü† Aujourd'hui</span>`;
  return `<span class="relance-badge ok">‚úì J+${rem}</span>`;
}

// ============================================================
// ACTIONS
// ============================================================
async function updateStatus(id, val) {
  const p = prospects.find(x=>x.id===id); if(!p)return;
  const old = p.statut; p.statut = val;
  addHistory(id, `Statut : "${old||'vide'}" ‚Üí "${val}"`);
  await updateSheetRow(p, ['statut']);
  updateKPIs(); renderChart(); applyFilters();
  toast('Statut mis √† jour','success');
}

async function updateDate(id, val) {
  const p = prospects.find(x=>x.id===id); if(!p)return;
  p.dateContact = val; addHistory(id, `Date de contact : ${val}`);
  await updateSheetRow(p, ['dateContact']);
  updateKPIs(); applyFilters();
}

async function updateNotes(id, val) {
  const p = prospects.find(x=>x.id===id); if(!p)return;
  p.notes = val;
  await updateSheetRow(p, ['notes']);
}

function openEmail(id, event) {
  event.stopPropagation();
  const p = prospects.find(x=>x.id===id); if(!p||!p.email)return;
  if(!p.dateContact) {
    p.dateContact = new Date().toISOString().split('T')[0];
    addHistory(id,`Date auto-remplie : ${p.dateContact}`);
    updateSheetRow(p, ['dateContact']); applyFilters();
  }
  window.location.href = `mailto:${p.email}?subject=${encodeURIComponent('Horo AI ‚Äî R√©ceptionniste IA Vocale | '+(p.cabinet||p.praticien))}`;
  toast(`‚úâÔ∏è Email ouvert pour ${p.praticien}`,'success');
}

// ============================================================
// HISTORY (localStorage only)
// ============================================================
function addHistory(id, text) {
  if(!history[id])history[id]=[];
  const now = new Date();
  history[id].unshift({ time: now.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}), text });
  localStorage.setItem('horo_history', JSON.stringify(history));
}

function openHistory(id) {
  const p = prospects.find(x=>x.id===id); if(!p)return;
  document.getElementById('modal-prospect-name').textContent = p.cabinet||p.praticien||'Prospect';
  document.getElementById('modal-prospect-sub').textContent = p.ville+(p.email?' ¬∑ '+p.email:'');
  const entries = history[id]||[];
  document.getElementById('history-list').innerHTML = entries.length===0
    ?'<div class="empty-history">Aucune activit√© enregistr√©e.</div>'
    :entries.map(e=>`<div class="history-item"><div class="history-dot"></div><div><div class="history-time">${e.time}</div><div class="history-text">${e.text}</div></div></div>`).join('');
  document.getElementById('history-modal').classList.add('open');
}

function closeModal(){document.getElementById('history-modal').classList.remove('open');}
document.getElementById('history-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});

// ============================================================
// FILTERS
// ============================================================
function applyFilters() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const status = document.getElementById('filter-status').value;
  const city = document.getElementById('filter-city').value;
  renderTable(prospects.filter(p => {
    const ms = !search||[p.cabinet,p.praticien,p.email,p.ville].some(v=>v&&v.toLowerCase().includes(search));
    const mst = !status||p.statut===status;
    const mc = !city||p.ville===city;
    const mu = !urgentFilterActive||['late','today'].includes(getRelanceStatus(p));
    return ms&&mst&&mc&&mu;
  }));
}

function toggleUrgentFilter(){
  urgentFilterActive=!urgentFilterActive;
  document.getElementById('btn-urgent-filter').classList.toggle('active',urgentFilterActive);
  applyFilters();
}

function checkUrgentNotifications() {
  const n = prospects.filter(p=>['late','today'].includes(getRelanceStatus(p))).length;
  if(n>0) setTimeout(()=>sendNotification('Horo AI ‚Äî Relances',`üî• ${n} relance(s) urgente(s) aujourd'hui`),1000);
}

// ============================================================
// RESET
// ============================================================
function resetApp() {
  if(!confirm('Effacer l\'historique local ?'))return;
  localStorage.removeItem('horo_history');
  history = {};
  toast('Historique effac√©');
}

// ============================================================
// TOAST
// ============================================================
function toast(msg,type='') {
  const el=document.createElement('div');
  el.className=`toast ${type}`; el.textContent=msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>el.remove(),3500);
}
</script>
</body>
</html>
